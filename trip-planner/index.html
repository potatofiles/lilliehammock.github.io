<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Planner — Day / Trip / Location</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#12141a;--text:#f1f5f9;--brand:#4f46e5;
      --flight:#0ea5e9;--train:#22c55e;--grid:#2a2f3a;--toastbg:#0f172a;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0e1116,#0a0c10 30%);color:var(--text)}
    header{padding:16px 24px;border-bottom:1px solid #1f2430;position:sticky;top:0;background:rgba(11,12,16,.9);backdrop-filter:blur(6px);z-index:20}
    header h1{margin:0 0 8px;font-size:20px}
    .tabs{display:flex;gap:8px}
    .tab{appearance:none;border:1px solid #2a3142;background:#141826;color:#cbd5e1;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;font-size:13px}
    .tab.active{background:var(--brand);border-color:transparent;color:#fff}
    .container{display:grid;grid-template-columns:390px 1fr;gap:18px;padding:18px 24px 28px;align-items:start}
    .card{background:#12141a;border:1px solid #1f2430;border-radius:var(--radius);box-shadow:0 6px 22px rgba(0,0,0,.35)}
    .card .head{padding:16px 16px 6px;border-bottom:1px solid #1b2030}
    .card .body{padding:14px 16px 16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{font-size:12px;color:#a7adbb;display:block;margin-bottom:6px}
    select,input[type="date"],input[type="file"],input[type="text"],input[type="datetime-local"],button{width:100%;background:#0f1219;color:var(--text);border:1px solid #252a38;border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer;background:var(--brand);border-color:transparent;font-weight:600}
    button.secondary{background:#1f2430;border:1px solid #2a3142}
    .calendarShell{background:#12141a;border:1px solid #1f2430;border-radius:var(--radius);overflow:hidden}
    .calendarHeader{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1b2030}
    .calendar{position:relative;height:960px;background:linear-gradient(180deg,#0d1017,#0a0d14)}
    .hours{position:absolute;left:0;top:0;bottom:0;width:64px;border-right:1px solid #1b2030}
    .hourRow{position:absolute;left:0;width:100%;height:40px;border-bottom:1px dashed var(--grid);color:#cbd5e1;font-size:12px;display:flex;align-items:flex-start;padding-top:2px;padding-left:8px}
    .timeline{position:absolute;left:64px;right:0;top:0;bottom:0}
    .halfHour{position:absolute;left:0;right:0;height:20px;border-bottom:1px solid rgba(255,255,255,.04)}
    .block{position:absolute;left:72px;right:16px;border-radius:12px;padding:10px 12px;color:#0b0c10;font-weight:600;box-shadow:0 6px 18px rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.15)}
    .block .sub{display:block;font-weight:500;opacity:.85;color:#0b0c10;font-size:12px;margin-top:2px}
    .flight{background:rgba(14,165,233,.85)}
    .train{background:rgba(34,197,94,.88)}
    .other{background:rgba(245,158,11,.88)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;background:#121827;border:1px solid #2a3142;border-radius:999px;font-size:12px;color:#cbd5e1}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tiny{font-size:11px;color:#94a3b8}
    .tripCal{position:relative;height:960px;background:linear-gradient(180deg,#0d1017,#0a0d14);overflow:hidden}
    .tripHours{position:absolute;left:0;top:0;bottom:0;width:64px;border-right:1px solid #1b2030}
    .tripCols{position:absolute;left:64px;right:0;top:0;bottom:0;display:grid;gap:8px;overflow-x:auto;padding:0 8px 0 0}
    .dayCol{position:relative;background:#0f1219;border:1px solid #1b2030;border-radius:12px;overflow:hidden;min-width:240px}
    .dayHead{padding:8px 10px;font-weight:700;font-size:13px;color:#e2e8f0;border-bottom:1px solid #1b2030;background:#0f1522;position:sticky;top:0;z-index:5}
    .dayBody{position:relative;height:calc(100% - 36px)}
    .tripHalf{position:absolute;left:0;right:0;height:20px;border-bottom:1px solid rgba(255,255,255,.04)}
    .tripBlock{position:absolute;left:8px;right:8px;border-radius:10px;padding:8px 10px;color:#0b0c10;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12)}
    #toast{position:fixed;right:16px;bottom:16px;background:var(--toastbg);color:#e5e7eb;border:1px solid #243041;border-radius:12px;padding:10px 14px;box-shadow:0 10px 24px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:9999}
    #toast.show{opacity:1}
    .hidden{display:none!important}
    @media(max-width:980px){.container{grid-template-columns:1fr}.calendar .block{left:12px;right:12px}.timeline{left:52px}.hours,.tripHours{width:48px}.dayCol{min-width:220px}}
  </style>
</head>
<body>
  <header>
    <h1>Trip Planner — Day / Trip / Location</h1>
    <div class="tabs">
      <button class="tab active" data-tab="day">Day</button>
      <button class="tab" data-tab="trip">Trip</button>
      <button class="tab" data-tab="location">Location</button>
    </div>
  </header>

  <div class="container">
    <!-- LEFT: Controls -->
    <section class="card">
      <div class="head"><h2>Data & Controls</h2></div>
      <div class="body">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
          <div>
            <label style="margin:0">Transportation CSV</label>
            <input id="fileTrans" type="file" accept=".csv" />
          </div>
          <button id="loadSample" class="secondary" title="Load demo data">Load sample</button>
        </div>
        <p class="tiny">This page auto-loads <b>transportation.csv</b> from this folder if present. You can also upload a CSV manually above.</p>

        <div class="grid2" style="margin-top:12px">
          <div><label for="tripStart">Trip start</label><input id="tripStart" type="date" /></div>
          <div><label for="tripEnd">Trip end</label><input id="tripEnd" type="date" /></div>
        </div>
        <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
          <button id="tripUseData" class="secondary">Use range from data</button>
          <button id="tripApply" class="secondary">Apply dates</button>
        </div>

        <div class="grid2" style="margin-top:14px">
          <div>
            <label for="daySelect">Day (Day view)</label>
            <select id="daySelect"></select>
          </div>
          <div>
            <label for="modeFilter">Filter by Mode</label>
            <select id="modeFilter">
              <option value="">All</option>
              <option>Train</option>
              <option>Flight</option>
            </select>
          </div>
        </div>

        <div id="legControls" style="margin-top:14px" class="grid3">
          <div><label for="leg1">Leg 1</label><select id="leg1"></select></div>
          <div><label for="leg2">Leg 2</label><select id="leg2"></select></div>
          <div><label for="leg3">Leg 3</label><select id="leg3"></select></div>
        </div>

        <details style="margin-top:14px">
          <summary class="tiny" style="cursor:pointer">Quick add item (manual)</summary>
          <div class="grid2" style="margin-top:8px">
            <div><label>Type</label><select id="qaType"><option>Transportation</option><option>Activity</option></select></div>
            <div><label>Mode / Category</label><input id="qaModeCat" type="text" placeholder="Train / Flight / Tour..." /></div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div><label>Location</label><input id="qaLoc" type="text" placeholder="Tashkent / Almaty..." /></div>
            <div><label>Title / Description</label><input id="qaTitle" type="text" placeholder="Option label or activity title" /></div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div><label>Start</label><input id="qaStart" type="datetime-local" /></div>
            <div><label>End</label><input id="qaEnd" type="datetime-local" /></div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div><label>Price</label><input id="qaPrice" type="text" placeholder="$" /></div>
            <div><label>Notes (optional)</label><input id="qaNotes" type="text" /></div>
          </div>
          <div style="margin-top:8px; display:flex; gap:8px">
            <button id="qaAdd" class="secondary">Add to planner</button>
            <span class="tiny">(Manual adds are temporary—upload a CSV to persist.)</span>
          </div>
        </details>

        <div style="margin-top:12px" id="legend" class="legend"></div>
      </div>
    </section>

    <!-- RIGHT: Day View -->
    <section class="calendarShell" id="view-day">
      <div class="calendarHeader">
        <h3 id="dayTitle">Select a day</h3>
        <div class="tiny" id="summary"></div>
      </div>
      <div class="calendar" id="calendar-day">
        <div class="hours" id="hours-day"></div>
        <div class="timeline" id="timeline-day"></div>
      </div>
    </section>

    <!-- Trip View -->
    <section class="calendarShell hidden" id="view-trip">
      <div class="calendarHeader"><h3>Trip view — Outlook-style</h3><div class="tiny" id="tripSummary"></div></div>
      <div class="tripCal" id="tripCal">
        <div class="tripHours" id="tripHours"></div>
        <div class="tripCols" id="tripCols"></div>
      </div>
    </section>

    <!-- Location View -->
    <section class="calendarShell hidden" id="view-location">
      <div class="calendarHeader"><h3 id="locTitle">Location view</h3></div>
      <div class="calendar" id="calendar-loc">
        <div class="hours" id="hours-loc"></div>
        <div class="timeline" id="timeline-loc"></div>
      </div>
    </section>
  </div>

  <div id="toast"></div>

  <script>
    /* ---------- Tiny helpers ---------- */
    const byId=(id)=>document.getElementById(id);
    const fmtTime=(d)=>d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const fmtDateTitle=(d)=>d.toLocaleDateString([], {weekday:'long', month:'short', day:'numeric'});
    const fmtDayShort=(d)=>d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
    const toast=(m)=>{const t=byId('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200)};

    /* ---------- CSV parsing (comma / semicolon / tab; quoted cells supported) ---------- */
    function detectDelimiter(text){
      const first=(text.split(/\r?\n/)[0]||'');
      const cnt=(d)=> (first.match(new RegExp((d==='\\t'? '\\t': d).replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&'),'g'))||[]).length;
      const arr=[{d:',',n:cnt(',')},{d:';',n:cnt(';')},{d:'\\t',n:cnt('\\t')}].sort((a,b)=>b.n-a.n);
      return arr[0].n>0? arr[0].d : ',';
    }
    function parseCSV(text){
      const delim=detectDelimiter(text);
      const rows=[]; let i=0,cur='',inQ=false,row=[];
      const pushCell=()=>{row.push(cur);cur=''}; const pushRow=()=>{if(row.length && row.some(c=>c!=='')) rows.push(row);row=[]};
      while(i<text.length){
        const ch=text[i];
        if(ch==='\"'){ if(inQ && text[i+1]==='\"'){cur+='\"';i++;} else inQ=!inQ; }
        else if(ch===delim && !inQ){ pushCell(); }
        else if((ch==='\\n'||ch==='\\r') && !inQ){ pushCell(); pushRow(); if(ch==='\\r'&&text[i+1]==='\\n') i++; }
        else cur+=ch;
        i++;
      }
      if(cur!==''||inQ){pushCell()} if(row.length) pushRow(); if(!rows.length) return [];
      const rawHeaders=rows.shift().map(h=>h.trim());
      const mapKey=(h)=>{ const k=h.toLowerCase().replace(/[\\s_\\-/()]+/g,'');
        if(['mode','transport','transportmode','type'].includes(k)) return 'Mode';
        if(['location','city','place'].includes(k)) return 'Location';
        if(['description','desc','details'].includes(k)) return 'Description';
        if(['start','startdatetime','startdate','datetime','starttime'].includes(k)) return 'Start Date/Time';
        if(['end','enddatetime','enddate','endtime'].includes(k)) return 'End Date/Time';
        if(['duration','dur'].includes(k)) return 'Duration';
        if(['price','cost'].includes(k)) return 'Price';
        if(['optionlabel','option','label'].includes(k)) return 'OptionLabel';
        return h;
      };
      const headers=rawHeaders.map(mapKey);
      return rows.map(r=>{ const o={}; headers.forEach((h,idx)=>o[h]=(r[idx]??'').trim()); return o; });
    }

    /* ---------- Date helpers (supports ISO, MM/DD/YYYY, DD/MM/YYYY, with or without AM/PM) ---------- */
    function parseDateSmart(str){
      if(!str) return null; if(str instanceof Date) return str;
      const iso=new Date(str); if(!isNaN(iso)) return iso;
      const m=String(str).match(/^(\\d{1,4})[\\/-](\\d{1,2})[\\/-](\\d{1,4})(?:[ T](\\d{1,2}):(\\d{2})(?::(\\d{2}))?(?:\\s*(AM|PM))?)?$/i);
      if(m){
        let a=+m[1], b=+m[2], c=+m[3], hh=+(m[4]||0), mm=+(m[5]||0), ss=+(m[6]||0), ap=(m[7]||'').toUpperCase();
        let y,M,d;
        if(String(a).length===4){ y=a; M=b; d=c; }
        else if(String(c).length===4){ y=c; if(a>12){ d=a; M=b; } else { M=a; d=b; } }
        else { y=c; M=a; d=b; }
        if(ap==='PM' && hh<12) hh+=12; if(ap==='AM' && hh===12) hh=0;
        const dt=new Date(y,M-1,d,hh,mm,ss); if(!isNaN(dt)) return dt;
      }
      return null;
    }
    const toDate=(v)=>parseDateSmart(v);
    const startOfDay=(d)=>{const x=new Date(d);x.setHours(0,0,0,0);return x};
    const endOfDay=(d)=>{const x=new Date(d);x.setHours(24,0,0,0);return x};
    const minutesSinceStart=(d)=>d.getHours()*60+d.getMinutes();

    function clampOverlap(seg, day){
      const s=toDate(seg["Start Date/Time"]), e=toDate(seg["End Date/Time"]);
      if(!s||!e) return null;
      const ds=startOfDay(day), de=endOfDay(day);
      const a=new Date(Math.max(s,ds)), b=new Date(Math.min(e,de));
      if(b<=a) return null; return [minutesSinceStart(a), minutesSinceStart(b)];
    }

    /* ---------- Colors ---------- */
    function hashCode(str){let h=0; for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0} return Math.abs(h)}
    function colorFromKey(key){const h=hashCode(key)%360;return `hsl(${h} 70% 55%)`}
    function modeKey(seg){const m=(seg.Mode||'').trim().toLowerCase(); return m||'other'}
    function blockStyle(seg){ const key=modeKey(seg); if(key.includes('flight')) return {cls:'flight',bg:null}; if(key.includes('train')) return {cls:'train',bg:null}; return {cls:'other',bg:colorFromKey(key)} }

    /* ---------- State ---------- */
    let transport=[]; let activities=[]; let selections={};

    function computeDataRange(){
      const t=[]; const add=(d)=>{if(d)t.push(startOfDay(d).getTime())};
      transport.forEach(r=>{add(toDate(r["Start Date/Time"])); add(toDate(r["End Date/Time"]))});
      activities.forEach(r=>{add(toDate(r["Start Date/Time"])); add(toDate(r["End Date/Time"]))});
      if(!t.length) return {start:null,end:null};
      return {start:new Date(Math.min(...t)), end:new Date(Math.max(...t))};
    }
    function setTripInputsFromRange(){
      const {start,end}=computeDataRange(); if(!start||!end) return;
      byId('tripStart').value=start.toISOString().slice(0,10);
      byId('tripEnd').value=end.toISOString().slice(0,10);
    }
    function getTripRange(){
      const s=byId('tripStart').value, e=byId('tripEnd').value;
      if(!s||!e) return null; return {start:new Date(s+'T00:00:00'), end:new Date(e+'T00:00:00')};
    }
    function daysBetween(start,end){const out=[]; if(!start||!end)return out; let d=new Date(start); while(d<=end){out.push(new Date(d)); d.setDate(d.getDate()+1)} return out}

    /* ---------- Renderers ---------- */
    function renderGrid(hoursEl, timelineEl, container){
      hoursEl.innerHTML=''; timelineEl.innerHTML='';
      const total=24*60, ppm=container.clientHeight/total;
      for(let h=0;h<=24;h++){ const row=document.createElement('div'); row.className='hourRow'; row.style.top=(h*60*ppm)+'px'; row.style.height=(60*ppm)+'px'; row.textContent=(h<10?'0':'')+h+':00'; hoursEl.appendChild(row) }
      for(let m=0;m<total;m+=30){ const line=document.createElement('div'); line.className='halfHour'; line.style.top=(m*ppm)+'px'; timelineEl.appendChild(line) }
    }
    function drawBlocksOnTimeline(timelineEl, containerEl, day, segs){
      const total=24*60, ppm=containerEl.clientHeight/total;
      Array.from(timelineEl.querySelectorAll('.block')).forEach(n=>n.remove());
      if(!day) return;
      segs.forEach(seg=>{
        if(!seg) return;
        const rng=clampOverlap(seg,day); if(!rng) return;
        const [smin,emin]=rng, top=smin*ppm, h=Math.max(18,(emin-smin)*ppm);
        const s=toDate(seg["Start Date/Time"]), e=toDate(seg["End Date/Time"]);
        const label= seg.OptionLabel || seg.Title || seg.Description || '';
        const st=blockStyle(seg); const d=document.createElement('div');
        d.className=`block ${st.cls}`; if(st.bg) d.style.background=st.bg;
        d.style.top=top+'px'; d.style.height=h+'px';
        d.innerHTML=`<div>${label}</div><span class="sub">${fmtTime(s)} → ${fmtTime(e)} · ${(seg.Mode||seg.Category||'')} ${seg.Price?(' · '+seg.Price):''}</span>`;
        timelineEl.appendChild(d);
      });
    }

    const calDay=byId('calendar-day'), hoursDay=byId('hours-day'), timeDay=byId('timeline-day');

    function optionsForDay(day, mode){
      return transport.filter(r=>{
        if(mode && r.Mode!==mode) return false;
        const s=toDate(r["Start Date/Time"]), e=toDate(r["End Date/Time"]); if(!s||!e) return false;
        const ds=startOfDay(day).getTime(), de=endOfDay(day).getTime();
        return e.getTime()>ds && s.getTime()<de;
      }).sort((a,b)=> new Date(a["Start Date/Time"]) - new Date(b["Start Date/Time"]));
    }
    function fillDropdown(sel, opts){
      sel.innerHTML=''; const none=document.createElement('option'); none.value=''; none.textContent='— none —'; sel.appendChild(none);
      opts.forEach((o,i)=>{ const op=document.createElement('option'); op.value=i; op.textContent=o.OptionLabel || `${o.Description||''} (${o.Mode||''})`; sel.appendChild(op); });
      sel.dataset.count=opts.length;
    }
    function saveSelection(day, legId, obj){ const iso=startOfDay(day).toISOString(); if(!selections[iso]) selections[iso]={leg1:null,leg2:null,leg3:null}; selections[iso][legId]=obj||null; }
    function restoreSelection(day, legId, opts, sel){ const iso=startOfDay(day).toISOString(); const picked=selections[iso]?.[legId]; if(!picked){ sel.selectedIndex=0; return; } const idx=opts.findIndex(o=>(o.OptionLabel||'')===(picked.OptionLabel||'')); sel.selectedIndex= idx>=0? idx+1 : 0; }
    function activitiesForDay(day){ if(!activities.length) return []; return activities.filter(a=>{ const s=toDate(a["Start Date/Time"]), e=toDate(a["End Date/Time"]); if(!s||!e) return false; return e>startOfDay(day) && s<endOfDay(day); }); }

    function refreshDayPicker(){
      const sel=byId('daySelect'); sel.innerHTML='';
      const tr=getTripRange(); const days=tr? daysBetween(tr.start,tr.end):[];
      days.forEach((d,i)=>{ const op=document.createElement('option'); op.value=d.toISOString(); op.textContent=fmtDayShort(d); if(i===0) op.selected=true; sel.appendChild(op); });
    }
    function populateLegDropdowns(){
      const val=byId('daySelect').value; if(!val) return; const day=new Date(val);
      const mode=byId('modeFilter').value; const opts=optionsForDay(day,mode);
      fillDropdown(byId('leg1'),opts); fillDropdown(byId('leg2'),opts); fillDropdown(byId('leg3'),opts);
      restoreSelection(day,'leg1',opts,byId('leg1')); restoreSelection(day,'leg2',opts,byId('leg2')); restoreSelection(day,'leg3',opts,byId('leg3'));
    }
    function drawDay(){
      const val=byId('daySelect').value; const day=val? new Date(val):null;
      renderGrid(hoursDay, timeDay, calDay);
      byId('dayTitle').textContent = day? fmtDateTitle(day): 'Select a day';
      const mode=byId('modeFilter').value; const opts=day? optionsForDay(day,mode):[];
      const picks=['leg1','leg2','leg3'].map(id=>{ const idx=byId(id).selectedIndex-1; return (idx>=0&&day)? opts[idx] : null; });
      const merged=picks.concat(activitiesForDay(day)); drawBlocksOnTimeline(timeDay,calDay,day,merged);
      const prices=picks.filter(Boolean).map(x=>x.Price).filter(Boolean).map(s=>String(s).replace(/\$/g,''));
      byId('summary').textContent = prices.length? `Selected prices: $${prices.join(' · $')}`:'';
    }

    /* Trip view */
    function renderTripGrid(){
      const tr=getTripRange(); const cols=byId('tripCols'), hours=byId('tripHours'), cal=byId('tripCal');
      cols.innerHTML=''; hours.innerHTML=''; if(!tr) return;
      const days=daysBetween(tr.start,tr.end), total=24*60, ppm=cal.clientHeight/total;
      for(let h=0;h<=24;h++){ const row=document.createElement('div'); row.className='hourRow'; row.style.top=(h*60*ppm)+'px'; row.style.height=(60*ppm)+'px'; row.textContent=(h<10?'0':'')+h+':00'; hours.appendChild(row) }
      cols.style.gridTemplateColumns=`repeat(${days.length}, minmax(240px,1fr))`;
      days.forEach(day=>{
        const col=document.createElement('div'); col.className='dayCol';
        const head=document.createElement('div'); head.className='dayHead'; head.textContent=fmtDayShort(day);
        const body=document.createElement('div'); body.className='dayBody';
        for(let m=0;m<total;m+=30){ const line=document.createElement('div'); line.className='tripHalf'; line.style.top=(m*ppm)+'px'; body.appendChild(line) }
        const iso=startOfDay(day).toISOString(); const picks=(selections[iso]||{});
        const segs=[picks.leg1,picks.leg2,picks.leg3].filter(Boolean);
        if(activities.length){
          segs.push(...activities.filter(a=>{ const s=toDate(a["Start Date/Time"]), e=toDate(a["End Date/Time"]); if(!s||!e) return false; return e>startOfDay(day)&&s<endOfDay(day); }));
        }
        segs.forEach(seg=>{
          const rng=clampOverlap(seg,day); if(!rng) return;
          const [smin,emin]=rng, top=smin*ppm, h=Math.max(18,(emin-smin)*ppm);
          const label= seg.OptionLabel || seg.Title || seg.Description || '';
          const st=blockStyle(seg); const d=document.createElement('div'); d.className=`tripBlock ${st.cls}`; if(st.bg) d.style.background=st.bg;
          d.style.top=top+'px'; d.style.height=h+'px'; d.title=`${label}`; d.textContent=label; body.appendChild(d);
        });
        col.appendChild(head); col.appendChild(body); cols.appendChild(col);
      });
    }

    /* Legend */
    function updateLegend(){
      const el=byId('legend'); el.innerHTML='';
      const pill=(label,color)=>{ const s=document.createElement('span'); s.className='pill'; s.innerHTML=`<span style="width:10px;height:10px;border-radius:999px;background:${color};"></span>${label}`; el.appendChild(s); };
      pill('Train', getComputedStyle(document.documentElement).getPropertyValue('--train'));
      pill('Flight', getComputedStyle(document.documentElement).getPropertyValue('--flight'));
      const modes=[...new Set(transport.map(t=>(t.Mode||'').trim()).filter(Boolean))].sort();
      modes.forEach(m=>{ const lo=m.toLowerCase(); if(lo.includes('train')||lo.includes('flight')) return; pill(m, colorFromKey(m)); });
    }

    /* Location view (basic filter using chosen legs + activities of that day) */
    function drawLocation(){
      const dayVal=byId('daySelect').value; const day=dayVal? new Date(dayVal):null;
      const hours=byId('hours-loc'), timeline=byId('timeline-loc'), cal=byId('calendar-loc');
      renderGrid(hours, timeline, cal); byId('locTitle').textContent='Location view';
      const iso=day? startOfDay(day).toISOString():null; const picks=iso? (selections[iso]||{}):{};
      const segs=[picks.leg1,picks.leg2,picks.leg3].filter(Boolean);
      if(day&&activities.length){ segs.push(...activities.filter(a=>{ const s=toDate(a["Start Date/Time"]), e=toDate(a["End Date/Time"]); return s&&e && e>startOfDay(day)&&s<endOfDay(day); })); }
      drawBlocksOnTimeline(timeline, cal, day, segs);
    }

    /* ---------- Wiring ---------- */
    function initAfterData(){ setTripInputsFromRange(); refreshDayPicker(); populateLegDropdowns(); renderGrid(byId('hours-day'), byId('timeline-day'), byId('calendar-day')); drawDay(); renderTripGrid(); drawLocation(); updateLegend(); }

    // Sample data button (optional)
    const sampleTransport=`Mode,Location,Description,Start Date/Time,End Date/Time,Duration,Price,OptionLabel
Train,,Tashkent-Samarkand,10/14/2025 6:33,10/14/2025 8:46,2:13,$32.06,Tashkent-Samarkand | 10/14 6:33 → 10/14 8:46
Flight,,Tashkent-Almaty,10/16/2025 19:10,10/16/2025 20:40,1:30,$78.00,Tashkent-Almaty | 10/16 19:10 → 10/16 20:40`;
    byId('loadSample').addEventListener('click',()=>{ transport=parseCSV(sampleTransport); selections={}; initAfterData(); toast(`Loaded sample: ${transport.length} rows`) });

    // Manual upload still works
    byId('fileTrans').addEventListener('change', e=>{
      const f=e.target.files[0]; if(!f) return;
      const rdr=new FileReader(); rdr.onload=()=>{ transport=parseCSV(rdr.result); selections={}; initAfterData(); toast(`Loaded transportation: ${transport.length} rows`) };
      rdr.readAsText(f);
    });

    // Day / filters / legs
    byId('daySelect').addEventListener('change', ()=>{ populateLegDropdowns(); drawDay(); drawLocation(); });
    byId('modeFilter').addEventListener('change', ()=>{ populateLegDropdowns(); drawDay(); });
    ['leg1','leg2','leg3'].forEach(id=> byId(id).addEventListener('change', ()=>{
      const v=byId('daySelect').value; if(!v) return; const day=new Date(v), mode=byId('modeFilter').value, opts=optionsForDay(day,mode);
      const idx=byId(id).selectedIndex-1; const obj=idx>=0? opts[idx]:null; saveSelection(day,id,obj); drawDay(); renderTripGrid(); drawLocation();
    }));

    // Quick add (in-memory only)
    function fmtLocal(dt){const p=(n)=>String(n).padStart(2,'0'); return `${dt.getFullYear()}-${p(dt.getMonth()+1)}-${p(dt.getDate())} ${p(dt.getHours())}:${p(dt.getMinutes())}`;}
    byId('qaAdd').addEventListener('click',()=>{
      const type=byId('qaType').value, modecat=byId('qaModeCat').value.trim(), loc=byId('qaLoc').value.trim(), title=byId('qaTitle').value.trim();
      const start=byId('qaStart').value, end=byId('qaEnd').value, price=byId('qaPrice').value.trim(), notes=byId('qaNotes').value.trim();
      if(!start||!end){alert('Start and End required.');return;}
      const sdt=new Date(start), edt=new Date(end); const s=fmtLocal(sdt), e=fmtLocal(edt);
      if(type==='Transportation'){ transport.push({Mode:modecat||'Other', Location:loc, Description:title, Price:price, OptionLabel:title||`${loc} | ${s} → ${e}`, "Start Date/Time":s, "End Date/Time":e}); }
      else { activities.push({Title:title||modecat||'Activity', Location:loc, Category:modecat||'Activity', Notes:notes, Price:price, "Start Date/Time":s, "End Date/Time":e}); }
      const tr=getTripRange(), sd=startOfDay(sdt), ed=startOfDay(edt);
      if(!tr||sd<tr.start||ed>tr.end){ byId('tripStart').value=(tr?(sd<tr.start?sd:tr.start):sd).toISOString().slice(0,10); byId('tripEnd').value=(tr?(ed>tr.end?ed:tr.end):ed).toISOString().slice(0,10); }
      refreshDayPicker(); renderTripGrid(); drawLocation(); drawDay(); toast('Added!');
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(btn=> btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const tab=btn.dataset.tab;
      byId('view-day').classList.toggle('hidden', tab!=='day');
      byId('view-trip').classList.toggle('hidden', tab!=='trip');
      byId('view-location').classList.toggle('hidden', tab!=='location');
      if(tab==='day'){ renderGrid(byId('hours-day'), byId('timeline-day'), byId('calendar-day')); drawDay(); }
      if(tab==='trip'){ renderTripGrid(); byId('tripCal').scrollTop=0; }
      if(tab==='location'){ drawLocation(); }
    }));

    // Reflow on resize
    window.addEventListener('resize', ()=>{
      const tab=document.querySelector('.tab.active')?.dataset.tab;
      if(tab==='day'){ renderGrid(byId('hours-day'), byId('timeline-day'), byId('calendar-day')); drawDay(); }
      if(tab==='trip'){ renderTripGrid(); }
      if(tab==='location'){ drawLocation(); }
    });

    /* ---------- AUTO-PRELOAD transportation.csv (GitHub Pages friendly) ---------- */
    window.addEventListener('load', async ()=>{
      try{
        const res=await fetch('./transportation.csv',{cache:'no-store'});
        if(res.ok){
          const text=await res.text();
          transport=parseCSV(text);
          selections={};
          initAfterData();
          toast(`Preloaded transportation: ${transport.length} rows`);
        } else {
          // Not found is OK; user can upload manually
          renderGrid(byId('hours-day'), byId('timeline-day'), byId('calendar-day'));
          renderTripGrid(); drawLocation(); 
          console.log('transportation.csv not found (optional preload).');
        }
      }catch(err){
        console.warn('Preload failed:', err);
      }
    });
  </script>
</body>
</html>
